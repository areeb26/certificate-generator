<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Certificate Generator</h1>
        
        <!-- Template Creation Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4">Create Template</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Template Name</label>
                <input type="text" id="templateName" placeholder="e.g., Course Completion Certificate" 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Upload Certificate Template</label>
                <input type="file" id="imageUpload" accept="image/*" 
                    class="w-full px-4 py-2 border rounded-lg">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Language</label>
                <select id="language" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="en">English</option>
                    <option value="ur">Urdu</option>
                </select>
            </div>

            <canvas id="canvas" class="border-2 border-gray-300 rounded-lg mb-4 max-w-full hidden cursor-crosshair"></canvas>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 hidden" id="positionHelp">
                <p class="text-sm text-blue-800">
                    <strong>üìç Position the text:</strong> Click or drag on the certificate to place the name exactly where you want it
                </p>
            </div>
            
            <div id="controls" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <div>
                    <label class="block text-sm font-medium mb-2">Font Family</label>
                    <select id="fontFamily" class="w-full px-4 py-2 border rounded-lg">
                        <option value="Arial">Arial</option>
                        <option value="Montserrat">Montserrat</option>
                        <option value="NotoNastaliqUrdu">Noto Nastaliq Urdu</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Font Size: <span id="fontSizeValue">48</span>px</label>
                    <input type="range" id="fontSize" min="20" max="150" value="48" 
                        class="w-full">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Text Alignment</label>
                    <select id="alignment" class="w-full px-4 py-2 border rounded-lg">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Text Color</label>
                    <input type="color" id="textColor" value="#000000" 
                        class="w-full h-10 px-2 py-1 border rounded-lg">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-2">Preview Name</label>
                    <input type="text" id="previewName" placeholder="Enter name for preview" 
                        class="w-full px-4 py-2 border rounded-lg">
                </div>
            </div>

            <div class="flex gap-4 mt-4">
                <button onclick="saveTemplate()" 
                    class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                    Save Template
                </button>
            </div>
        </div>

        <!-- Saved Templates Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">Saved Templates</h2>
            <div id="templatesList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-gray-500">Loading templates...</p>
            </div>
        </div>

        <!-- Generate Certificate Modal -->
        <div id="generateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-semibold mb-4">Generate Certificate</h3>
                <input type="text" id="certificateName" placeholder="Enter recipient name" 
                    class="w-full px-4 py-2 border rounded-lg mb-4">
                <div class="flex gap-4">
                    <button onclick="generateCertificate()" 
                        class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                        Generate
                    </button>
                    <button onclick="closeModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://certificate-generator-api-d8p2.onrender.com';
        let canvas, ctx, uploadedImage;
        let currentTemplateId = null;
        let templates = [];

        // Initialize
        window.onload = function() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            loadTemplates();
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            document.getElementById('fontSize').addEventListener('input', updatePreview);
            document.getElementById('fontFamily').addEventListener('change', updatePreview);
            document.getElementById('textColor').addEventListener('change', updatePreview);
            document.getElementById('alignment').addEventListener('change', updatePreview);
            document.getElementById('previewName').addEventListener('input', updatePreview);
            document.getElementById('language').addEventListener('change', function() {
                const lang = this.value;
                const fontSelect = document.getElementById('fontFamily');
                if (lang === 'ur') {
                    fontSelect.value = 'NotoNastaliqUrdu';
                    document.getElementById('previewName').value = 'ÿßÿ≠ŸÖÿØ ÿπŸÑ€å';
                    document.getElementById('alignment').value = 'center';
                } else {
                    fontSelect.value = 'Arial';
                    document.getElementById('previewName').value = 'John Doe';
                }
                updatePreview();
            });
        };

        async function loadTemplates() {
            try {
                const response = await fetch(`${API_URL}/api/templates`);
                const data = await response.json();
                templates = data.templates;
                displayTemplates();
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesList').innerHTML = 
                    '<p class="text-red-500">Failed to load templates</p>';
            }
        }

        function displayTemplates() {
            const list = document.getElementById('templatesList');
            if (templates.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No templates saved yet</p>';
                return;
            }

            list.innerHTML = templates.map(t => `
                <div class="border rounded-lg p-4 hover:shadow-md transition">
                    <h3 class="font-semibold text-lg mb-2">${t.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">
                        Language: ${t.language === 'ur' ? 'Urdu' : 'English'}<br>
                        Created: ${new Date(t.created_at).toLocaleDateString()}
                    </p>
                    <button onclick="openGenerateModal(${t.id})" 
                        class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Generate Certificate
                    </button>
                </div>
            `).join('');
        }

        let textPosition = { x: 0, y: 0 };
        let isDragging = false;

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    uploadedImage = img;
                    
                    const maxWidth = 1200;
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    
                    // Set initial text position
                    textPosition = {
                        x: canvas.width / 2,
                        y: canvas.height * 0.65
                    };
                    
                    canvas.classList.remove('hidden');
                    document.getElementById('controls').classList.remove('hidden');
                    document.getElementById('positionHelp').classList.remove('hidden');
                    
                    // Mouse events for dragging text
                    canvas.onmousedown = function(e) {
                        isDragging = true;
                        updateTextPosition(e);
                    };
                    
                    canvas.onmousemove = function(e) {
                        if (isDragging) {
                            updateTextPosition(e);
                        }
                    };
                    
                    canvas.onmouseup = function(e) {
                        isDragging = false;
                    };
                    
                    canvas.onmouseleave = function(e) {
                        isDragging = false;
                    };
                    
                    // Touch events for mobile
                    canvas.ontouchstart = function(e) {
                        e.preventDefault();
                        isDragging = true;
                        const touch = e.touches[0];
                        updateTextPosition(touch);
                    };
                    
                    canvas.ontouchmove = function(e) {
                        e.preventDefault();
                        if (isDragging) {
                            const touch = e.touches[0];
                            updateTextPosition(touch);
                        }
                    };
                    
                    canvas.ontouchend = function(e) {
                        e.preventDefault();
                        isDragging = false;
                    };
                    
                    updatePreview();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateTextPosition(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            textPosition.x = (e.clientX - rect.left) * scaleX;
            textPosition.y = (e.clientY - rect.top) * scaleY;
            
            updatePreview();
        }

        function updatePreview() {
            if (!uploadedImage) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);

            const name = document.getElementById('previewName').value || 'Sample Name';
            const fontSize = document.getElementById('fontSize').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const color = document.getElementById('textColor').value;
            const alignment = document.getElementById('alignment').value;
            const language = document.getElementById('language').value;

            document.getElementById('fontSizeValue').textContent = fontSize;

            // Set font with proper handling for Urdu
            if (language === 'ur') {
                ctx.font = `${fontSize}px "Noto Nastaliq Urdu", "Jameel Noori Nastaleeq", serif`;
                ctx.direction = 'rtl';
            } else {
                ctx.font = `${fontSize}px ${fontFamily}, sans-serif`;
                ctx.direction = 'ltr';
            }
            
            ctx.fillStyle = color;
            ctx.textBaseline = 'alphabetic'; // Changed from 'middle' to 'alphabetic' for proper baseline

            let x = textPosition.x;
            const y = textPosition.y;

            if (alignment === 'left') {
                ctx.textAlign = 'left';
            } else if (alignment === 'right') {
                ctx.textAlign = 'right';
            } else {
                ctx.textAlign = 'center';
            }

            ctx.fillText(name, x, y);
            
            // Draw a small crosshair at text position for reference
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x - 10, y);
            ctx.lineTo(x + 10, y);
            ctx.moveTo(x, y - 10);
            ctx.lineTo(x, y + 10);
            ctx.stroke();
        }

        async function saveTemplate() {
            if (!uploadedImage) {
                alert('Please upload an image first');
                return;
            }

            const templateName = document.getElementById('templateName').value.trim();
            if (!templateName) {
                alert('Please enter a template name');
                return;
            }

            const config = {
                name: templateName,
                image_base64: canvas.toDataURL('image/png'),
                text_position: {
                    x: textPosition.x,
                    y: textPosition.y
                },
                font: document.getElementById('fontFamily').value,
                font_size: parseInt(document.getElementById('fontSize').value),
                alignment: document.getElementById('alignment').value,
                color: document.getElementById('textColor').value,
                language: document.getElementById('language').value
            };

            try {
                const response = await fetch(`${API_URL}/api/template`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                alert('Template saved successfully!');
                
                // Reset form
                document.getElementById('templateName').value = '';
                document.getElementById('imageUpload').value = '';
                canvas.classList.add('hidden');
                document.getElementById('controls').classList.add('hidden');
                uploadedImage = null;
                
                // Reload templates
                loadTemplates();
            } catch (error) {
                alert('Failed to save template: ' + error.message);
            }
        }

        function openGenerateModal(templateId) {
            currentTemplateId = templateId;
            document.getElementById('generateModal').classList.remove('hidden');
            document.getElementById('certificateName').value = '';
            document.getElementById('certificateName').focus();
        }

        function closeModal() {
            document.getElementById('generateModal').classList.add('hidden');
            currentTemplateId = null;
        }

        async function generateCertificate() {
            const name = document.getElementById('certificateName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }

            try {
                const url = `${API_URL}/api/certificate/${currentTemplateId}?name=${encodeURIComponent(name)}`;
                window.open(url, '_blank');
                closeModal();
            } catch (error) {
                alert('Failed to generate certificate: ' + error.message);
            }
        }

        // Allow Enter key to generate certificate
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !document.getElementById('generateModal').classList.contains('hidden')) {
                generateCertificate();
            }
        });
    </script>
</body>
</html>